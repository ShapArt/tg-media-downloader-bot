name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  gitleaks:
    name: "🛡️ Secret scan (gitleaks)"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION=8.18.2
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz -o gitleaks.tgz
          tar -xzf gitleaks.tgz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
      - name: Scan repository
        run: gitleaks detect --no-banner --redact --config=gitleaks.toml --report-format sarif --report-path gitleaks.sarif
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks.sarif

  python:
    name: "🧪 Lint & test (py${{ matrix.python-version }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Pre-commit (non-blocking)
        run: pre-commit run --all-files --show-diff-on-failure
        continue-on-error: true
      - name: Tests (pytest)
        if: hashFiles('tests/**') != ''
        run: pytest -q
        continue-on-error: true

  node:
    name: "🎛️ Frontend checks (Node LTS)"
    if: hashFiles('package.json') != '' || hashFiles('pnpm-lock.yaml') != '' || hashFiles('yarn.lock') != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then npm ci --ignore-scripts; else npm install --ignore-scripts; fi
      - name: Lint (optional)
        run: npm run lint --if-present
        continue-on-error: true
      - name: Tests (optional)
        run: npm test --if-present
        continue-on-error: true
